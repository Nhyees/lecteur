<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist</title>
    <link rel="stylesheet" href="style_mobile.css">
</head>

<body>
    <div class="container">
        <div class="music-list" id="musicList">
            <h2>Songlist</h2>
            <input type="file" id="fileInput" accept=".json">
            <button id="exportButton" class="btn">üíæ</button>
        </div>
        
        <audio id="audioPlayer" controls style="display:none"></audio>
        <video id="videoPlayer" controls style="width: 100%"></video>
        <button id="prevButton" class="btn">‚èÆ Pr√©c√©dent</button>
        <button id="randomButton" class="btn">üîÄ</button>
        <button id="nextButton" class="btn">‚è≠ Suivant</button>

        <div id="songInfo">
            <p><strong>Anime :</strong> <span id="animeName"></span></p>
            <p><strong>Titre :</strong> <span id="songName"></span></p>
            <p><strong>Artiste :</strong> <span id="artistName"></span></p>
            <p><strong>Type :</strong> <span id="typeName"></span></p>
        </div>

        <div style="height: 15px;"></div>

    </div>


    <div id="player">
        üéµ Lecteur en cours...
    </div>


    <script>
        let musicData = [];
        let currentIndex = 0;
        let savedVolume = 0.3;
        let isShuffle = false;

        const audioPlayer = document.getElementById("audioPlayer");
        const musicList = document.getElementById("musicList");

        audioPlayer.addEventListener("volumechange", function() {
            savedVolume = audioPlayer.volume; // Sauvegarde la valeur du volume
        });

        document.getElementById("fileInput").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const newMusicData = JSON.parse(e.target.result);
                        musicData = musicData.concat(newMusicData); // Ajoute les nouvelles chansons √† la liste existante
                        displayMusicList();
                    } catch (error) {
                        alert("Erreur lors du chargement du fichier JSON");
                    }
                };
                reader.readAsText(file);
            }
        });


        function displayMusicList() {

            musicList.innerHTML = '<h2>Songlist</h2><input type="file" id="fileInput" accept=".json"><button id="exportButton" class="btn">üíæ</button>';

            document.getElementById("fileInput").addEventListener("change", handleFileUpload);
            document.getElementById("exportButton").addEventListener("click", exportPlaylist);

            musicData.forEach((music, index) => {
                const musicItem = document.createElement("div");
                musicItem.classList.add("music-item");
                musicItem.draggable = true;
                musicItem.dataset.index = index;
                musicItem.innerHTML = `
                    <h3>${music.songName} - ${music.artist}</h3>
                    <p><strong>Anime:</strong> ${music.animeJPName} | <strong>Type:</strong> ${music.type}</p>
                    <button class="delete-button" onclick="deleteMusic(${index})">‚ùå</button>
                `;

                musicItem.addEventListener("dragstart", dragStart);
                musicItem.addEventListener("dragover", dragOver);
                musicItem.addEventListener("drop", drop);

                musicItem.addEventListener("click", function() {
                    playMusic(index);
                });

                musicList.appendChild(musicItem);
            });

            highlightCurrentSong();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const newMusicData = JSON.parse(e.target.result);
                        musicData = musicData.concat(newMusicData); // Ajoute les nouvelles chansons
                        displayMusicList();
                    } catch (error) {
                        alert("Erreur lors du chargement du fichier JSON");
                    }
                };
                reader.readAsText(file);
            }
        }


        function dragStart(event) {
            event.dataTransfer.setData("text/plain", event.target.dataset.index);
        }

        function dragOver(event) {
            event.preventDefault();
        }

        function drop(event) {
            event.preventDefault();
            const fromIndex = event.dataTransfer.getData("text/plain");
            const toIndex = event.target.dataset.index;
            
            if (fromIndex !== undefined && toIndex !== undefined) {
                const movedItem = musicData.splice(fromIndex, 1)[0];
                musicData.splice(toIndex, 0, movedItem);
                displayMusicList();
            }
        }

        const videoPlayer = document.getElementById("videoPlayer");

        function playMusic(index) {
            if (musicData.length === 0) return;
            currentIndex = index;

            videoPlayer.src = musicData[currentIndex].video;
            audioPlayer.volume = savedVolume;
            videoPlayer.play();
            updateSongInfo();
            highlightCurrentSong();
        }



        function updateSongInfo() {
            const song = musicData[currentIndex];
            document.getElementById("songName").textContent = song.songName;
            document.getElementById("artistName").textContent = song.artist;
            document.getElementById("animeName").textContent = song.animeJPName;
            document.getElementById("typeName").textContent = song.type;
        }

        function highlightCurrentSong() {
            const items = document.querySelectorAll(".music-item");
            items.forEach((item, index) => {
                item.classList.toggle("active", index == currentIndex);
            });
        }

        // Ajouter des √©v√©nements de clic pour les boutons Pr√©c√©dent, Suivant et Lecture al√©atoire
        document.getElementById("prevButton").addEventListener("click", playPrevious);
        document.getElementById("nextButton").addEventListener("click", playNext);
        
        document.getElementById("randomButton").addEventListener("click", function () {
            isShuffle = !isShuffle;
            this.style.background = isShuffle ? "hsl(300, 50%, 40%)" : "hsl(300, 34%, 33%)"; // Change la couleur pour indiquer si activ√©
        });

        audioPlayer.addEventListener("ended", function () {
            if (isShuffle) {
                playRandomMusic();
            } else {
                playNext();
            }
        });



        function playRandomMusic() {
            if (musicData.length === 0) return;
            const randomIndex = Math.floor(Math.random() * musicData.length);
            playMusic(randomIndex);
        }

        function playPrevious() {
            if (musicData.length === 0) return;
            currentIndex = (currentIndex - 1 + musicData.length) % musicData.length;
            playMusic(currentIndex);
        }

        function playNext() {
            if (musicData.length === 0) return;
            if (isShuffle) {
                playRandomMusic();
            } else {
                currentIndex = (currentIndex + 1) % musicData.length;
                playMusic(currentIndex);
            }
        }


        function deleteMusic(index) {
            musicData.splice(index, 1);
            displayMusicList();
        }

        function exportPlaylist() {
            const json = JSON.stringify(musicData, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "playlist.json";
            link.click();
            URL.revokeObjectURL(url);
        }

        videoPlayer.addEventListener("ended", function() {
            playNext();
        });



    </script>
</body>
</html>